#!/usr/bin/env sh
set -e

BRANCH=$GIT_BRANCH
SOURCE_FILES=./bundle_output/*
REMOTE_SERVER=scdev@10.165.13.29
PACKAGE_NAME=srn_ui
ASSET_HOST=http://f2e.souche.com
SRNHUB_HOST=https://srn-hub.souche.com
ASSEST_IOS_URL=$ASSET_HOST/projects/react-native/modules/$PACKAGE_NAME/$VERSION/index.ios.jsbundle
ASSEST_ANDROID_URL=$ASSET_HOST/projects/react-native/modules/$PACKAGE_NAME/$VERSION/index.android.jsbundle

DEV_PATH=/home/scdev/dev/souche-f2e/projects/react-native/modules/$PACKAGE_NAME/$VERSION/

echo "正在发布 $VERSION ..."

# build
npm install --registry=http://registry.npm.souche-inc.com

# commit
npm version $VERSION --message "chore(package.json): bump version to $VERSION"

# publish
git push origin develop
git tag -a $VERSION -m "Release $VERSION"
git push origin refs/tags/$VERSION

snpm publish --tag $TAG

# bundle
echo "正在发布 bundle..."
mkdir -p bundle_output
rm -f ./bundle_output/*
react-native bundle --entry-file ./index.ios.js --bundle-output ./bundle_output/index.ios.jsbundle --platform ios --dev false
react-native bundle --entry-file ./index.android.js --bundle-output ./bundle_output/index.android.jsbundle --platform android --dev false
ssh $REMOTE_SERVER "mkdir -p $DEV_PATH"
rsync -rvI --progress $SOURCE_FILES $REMOTE_SERVER:$DEV_PATH
curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d "branch=$BRANCH&repository=$ASSEST_IOS_URL&version=$VERSION" "$SRNHUB_HOST/v1/bundle/$PACKAGE_NAME/ios"
curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d "branch=$BRANCH&repository=$ASSEST_ANDROID_URL&version=$VERSION" "$SRNHUB_HOST/v1/bundle/$PACKAGE_NAME/android"
echo
echo "bundle 发布成功。"

# deploy docs
if [ "$TAG" = "latest" ];then
	echo "正在部署文档..."
	npm run deploy

	echo
	echo "文档部署成功，请访问以下地址。"
	echo "最新版本文档：http://f2e.souche.com/projects/souche-ui/srn-ui/docs/components/init"
fi

echo
echo "$VERSION 发布成功."
