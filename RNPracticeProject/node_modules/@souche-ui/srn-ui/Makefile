# VERSION 和 BRANCH 通过 make publish-dev VERSION="0.1.1" BRANCH="feature/button" 方式传递
# VERSION 需要使用 beta 格式，前三位版本号需要和下一个版本一致，如 0.1.1-beta2

SOURCE_FILES=./build/*
REMOTE_SERVER=scdev@115.29.202.141
PACKAGE_NAME=srn_ui
ASSET_HOST=http://f2e.souche.com
SRNHUB_HOST=https://srn-hub.souche.com
ASSEST_IOS_URL=$(ASSET_HOST)/projects/react-native/modules/$(PACKAGE_NAME)/$(VERSION)/index.ios.jsbundle
ASSEST_ANDROID_URL=$(ASSET_HOST)/projects/react-native/modules/$(PACKAGE_NAME)/$(VERSION)/index.android.jsbundle

DEV_PATH=/home/scdev/dev/souche-f2e/projects/react-native/modules/$(PACKAGE_NAME)/$(VERSION)/

# 发布到测试环境
publish-dev:
	@echo '检查版本号是否重复...'
	@curl -s -X GET --header 'Accept: application/json' 'https://srn-hub.souche.com/v1/bundle/$(PACKAGE_NAME)/$(VERSION)/exists' | grep -q '"exists":false' && echo '版本号可用' || (echo '版本号不可用' && exit 1)
	@mkdir -p build
	@rm -f ./build/*
	react-native bundle --entry-file ./index.ios.js --bundle-output ./build/index.ios.jsbundle --platform ios --dev false
	react-native bundle --entry-file ./index.android.js --bundle-output ./build/index.android.jsbundle --platform android --dev false
	@ssh $(REMOTE_SERVER) 'mkdir -p $(DEV_PATH)'
	rsync -rvI --progress $(SOURCE_FILES) $(REMOTE_SERVER):$(DEV_PATH)
	curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'branch=$(BRANCH)&repository=$(ASSEST_IOS_URL)&version=$(VERSION)' '$(SRNHUB_HOST)/v1/bundle/$(PACKAGE_NAME)/ios'
	curl -X POST --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: application/json' -d 'branch=$(BRANCH)&repository=$(ASSEST_ANDROID_URL)&version=$(VERSION)' '$(SRNHUB_HOST)/v1/bundle/$(PACKAGE_NAME)/android'

.PHONY: publish-dev
