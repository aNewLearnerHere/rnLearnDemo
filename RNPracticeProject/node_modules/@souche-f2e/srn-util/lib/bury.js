import SRNFetch from './SRNFetch';
import {
    NativeModules
} from 'react-native';

function getPlatform() {
    const AppData = NativeModules.SCCRNAppData;
    if (!AppData) {
        return;
    }

    const app_name = AppData.appName.toLowerCase();
    if (app_name.indexOf('cheniu') !== -1) {
        return 'PLATFORM_CHENIU';
    } else if (app_name.indexOf('dafengche') !== -1 || app_name.indexOf('dfc') !== -1) {
        return 'PLATFORM_SELLERAPP';
    } else if (app_name.indexOf('tangeche') !== -1) {
        return 'PLATFORM_TANGECHE';
    } else if (app_name.indexOf('sccwk') !== -1) {
        return 'PLATFORM_SCCWK';
    } else {
        return '';
    }
}

function bury(key, obj = {}) {
    return new Promise(function(resolve, reject) {
        NativeModules.SCCRNAppData && NativeModules.SCCRNAppData.getAppData(function(err, AppData) {
            if (!AppData) {
                return resolve();
            }

            if (typeof key === 'string') {
                obj.typeId = key;
            } else if (typeof key === 'object') {
                obj = Object.assign({}, key, obj);
            }

            if (obj.typeId) {
                obj.typeid = obj.typeId;
            }
            if (obj.typeid) {
                obj.typeId = obj.typeid;
            }
            obj.usertag = obj.usertag || AppData.iid;
            obj.platform = obj.platform || getPlatform();

            
            const server = AppData.env == 1 ? 'https://niu.souche.com' :
                AppData.env == 2 ? 'http://niu.prepub.souche.com' : 'http://cheniu-dev.souche.com:8021';

            SRNFetch(server + '/data_log/common/add', {
                method: 'POST',
                data: {
                    token: AppData.userToken,
                    ...obj
                }
            }).then(res => resolve(res)).catch(res => reject(res));
        });
    });
}

export default bury;