#!/usr/bin/env node

try {
    var cp = require('child_process');
    var path = require('path');

    var axios = require('axios');

    // 执行脚本命令的地址
    var npmPath = process.cwd();
    // 当前 npm 的 package.json 文件
    var npmPackageJson = require(path.join(npmPath, 'package.json'));

    // 获取 node_modules 的 index 值
    var projectIndex = npmPath.indexOf('/node_modules');

    // 判断是不是在项目里还是工具里执行方法
    if (projectIndex === -1) process.exit(0);

    // 获取项目路径
    var projectPath = npmPath.slice(0, projectIndex);
    // 获取项目的 package.json 文件
    var projectPackageJson = require(path.join(projectPath, 'package.json'));
    // git 项目信息
    var projectGitInfo = '';

    // 获取项目 git 信息
    try {
        projectGitInfo = cp.execSync('git remote -v').toString();
    } catch (err) {
        process.exit(0);
    }

    // 上传到埋点库
    axios.post('http://traffic-v1.souche.com/api/trackApi/commonAdd.json', {}, {
        params: {
            usertag: 'mobi-arch',
            platform: 'PLATFORM_SOUCHE_INTERNAL_SERVICE',
            typeId: 'WIRELESS_NPM_STATISTICS',
            npmName: npmPackageJson.name,
            npmVersion: npmPackageJson.version,
            projectName: projectPackageJson.name,
            projectVersion: projectPackageJson.version,
            projectGit: projectGitInfo ? projectGitInfo.match(/(http|git).*git/)[0] : 'no git information'
        }
    }).catch(function(err) {});
} catch (err) {
    process.exit(0);
}
