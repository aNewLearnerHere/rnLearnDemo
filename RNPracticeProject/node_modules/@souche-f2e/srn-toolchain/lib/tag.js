'use strict';

const execSync = require('child_process').execSync;

const gitUtil = require('./git_util.js');
const versionUtil = require('./version.js');

const branch = gitUtil.getBranch();

/**
 * 发布一个版本
 * @param {String} version 这次发布的版本号
 * @param {Object} options
 */
function pushTag (version, options) {
    const commitMessage = `"chore(package.json): bump version to ${version}"`;
    const releaseMessage = options.releaseMessage ? `"${options.releaseMessage}"` : `"Release v${version}"`;

    try {
        // 升级 package.json 版本号
        versionUtil.bumpVersionSync(version);
        execSync(`git add package.json && git commit -m ${commitMessage}`, { stdio: 'ignore' });
    } catch (e) {

    }

    // eslint-disable-next-line
    const cmd = `git tag -a ${version} -m ${releaseMessage} && git push origin HEAD:${branch} && git push origin --tags`;

    execSync(cmd, { stdio: 'inherit' });
}

module.exports = {
    run: function (options, done) {
        const nextVersion = options.version;

        try {
            // 打 tag 并 push tags
            pushTag(nextVersion, options);

            // eslint-disable-next-line
            done();
        } catch (e) {
            // eslint-disable-next-line
            done(e);
        }
    }
};
