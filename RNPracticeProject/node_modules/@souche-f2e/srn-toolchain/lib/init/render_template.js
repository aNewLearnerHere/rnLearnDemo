'use strict';

const path = require('path');

const async = require('async');
const Metalsmith = require('metalsmith');
const render = require('consolidate').ejs.render;

const globalData = require('../global_data');

/**
 * 根据 template 模板，替换掉 src 下相应的文件
 */
function renderTemplates (files, metalsmith, done) {
    const keys = Object.keys(files);
    const metaData = metalsmith.metadata();
    async.each(keys, function (file, next) {
        const str = files[file].contents.toString();

        if (!/<%([^<>]+)%>/g.test(str)) {
            return next();
        }

        render(str, metaData, function (err, res) {
            if (err) return next(err);
            files[file].contents = new Buffer(res);
            next();
        });
    }, done);
}

module.exports = function (done) {
    // eslint-disable-next-line
    Metalsmith(__dirname)
        .metadata({
            moduleName: global.pkg.name
        })
        .clean(false)
        .use(renderTemplates)
        .source(globalData.RN_TEMPLATE_FOLDER)
        .destination(path.resolve(globalData.PROJECT_ROOT, './'))
        .build(function (err) {
            if (err) {
                return done(new Error('Init Module Template Fail\n'));
            }

            done();
        });
};
