'use strict';

const execSync = require('child_process').execSync;

const gitBranch = require('git-branch');

module.exports = {
    /**
     * 用于判断一个 tag 是否存在
     * @param  {String} tag [description]
     * @return {[type]}     [description]
     */
    checkTagExists: function (tag) {
        let tags = '';

        try {
            tags = execSync('git tag', { encoding: 'utf8' });
        } catch (e) {

        }

        return tags.indexOf(tag) !== -1;
    },

    /**
     * 删除一个 tag
     * @param  {String} tag [description]
     * @return {[type]}     [description]
     */
    removeTag: function (tag) {
        try {
            execSync(`git tag -d ${tag} && git push origin :${tag}`);
        } catch (e) {

        }
    },

    /**
     * 获取分支名称，jenkins 上通过环境变量传入；本地的话使用 git 命令获取
     */
    getBranch () {
        return this.getJenkinsBranch() || this.getLocalBranch();
    },

    /**
     * 在 jenkins 环境获取分支名称
     */
    getJenkinsBranch () {
        let branch = process.env.BRANCH_NAME;

        if (branch && branch.indexOf('refs/heads') === 0) {
            branch = branch.replace('refs/heads/', '');
        }

        return branch;
    },

    /**
     * 获取本地 git 分支
     */
    getLocalBranch () {
        return gitBranch.sync();
    }
};
