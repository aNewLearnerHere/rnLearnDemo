'use strict';

const fs = require('fs');
const path = require('path');

const glob = require('glob');
const moment = require('moment');

function updateImages () {
    let time = moment().format('YYYY-MM-DD HH:mm:ss');
    process.stdout.write(`[${time}] <START> Update Image Config File\n`);

    let routes = [];
    let imports = [];

    let projectDir = process.cwd();
    let pageDir = './src/images';
    let ctrlDir = path.resolve(projectDir, pageDir);

    // 遍历 src/images 下的文件
    glob.sync(ctrlDir + '/**/*.+(png|jpg|gif|jpeg)').forEach(function (file) {
        file = file.replace(/\/index\.(png|jpg|gif|jpeg)$/, '');
        let routePath = file.replace(ctrlDir, '').replace('.js', '');
        let moduleName = routePath.replace(/\//g, '_');

        imports.push(`import ${moduleName} from './images${routePath}';`);
        routes.push(`routeConfig['${routePath}'] = ${moduleName};`);
    });

    let routerFile = path.resolve(process.cwd(), './src/route_config.js');
    let routerContent = 'var routeConfig ={};\n\n' +
        imports.join('\n') + '\n\n' +
        routes.join('\n') + '\n\n' +
        'export default routeConfig;';

    fs.writeFileSync(routerFile, routerContent, 'utf8');
    process.stdout.write(`[${time}] <End>   Update Image Config File\n`);
}

module.exorts = {
    updateImages: updateImages
};
