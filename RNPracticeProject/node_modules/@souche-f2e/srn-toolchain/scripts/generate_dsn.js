/* eslint-disable max-len */
'use strict';

/**
 * 1. 检查 App.js 中的 dsn 内容
 * 2. create 一个新项目
 * 2. 生成 dsn
 * 3. 替换 dsn
 * 4. commit 文件
 * 5. push 提交
 */
const execSync = require('child_process').execSync;
const fs = require('fs');
const path = require('path');

const async = require('async');
const axios = require('axios');

const config = require('../config');
const gitUtil = require('../lib/git_util.js');

const PROJECT_ROOT = process.cwd();
const PACKAGE_JSON_PATH = path.resolve(PROJECT_ROOT, 'package.json');
const APP_MAIN_PATH = path.resolve(PROJECT_ROOT, 'src/App.js');
const pkg = require(PACKAGE_JSON_PATH);

// srn-template 改了目录结构，所以这个文件不存在了，临时处理一下
let appMainContent = '';
try {
    appMainContent = fs.readFileSync(APP_MAIN_PATH, { encoding: 'utf8' });
} catch (e) {
    process.exit(0);
}

const sentryToken = '9426a135a0e848079dd436ffb481e57070163bf38717480db25b357086644a7e';

/**
 * 检查 App.js 中的 dsn 内容
 */
if (appMainContent.indexOf('https://<key>@app.getsentry.com/<project>') === -1) {
    process.exit(0);
} else {
    console.log('Error: 请更换正确的 dsn 链接');
    process.exit(1);
}

// TODO ????
async.waterfall([
    function (next) {
        // 创建一个项目
        axios.post(`${config.sentryHost}/api/0/teams/sentry/react-native/projects/`, {
            name: `rn-${pkg.name}`
        }, {
            headers: {
                Authorization: `Bearer ${sentryToken}`,
                'Content-Type': 'application/json'
            }
        }).then(resp => {
            const projectSlug = resp.data.data.slug;
            next(null, projectSlug);
        }).catch(err => {
            next(err);
        });
    },
    function (projectSlug, next) {
        // 生成 dsn
        axios.post(`${config.sentryHost}/api/0/projects/react-native/${projectSlug}/keys/`, {}, {
            headers: {
                Authorization: `Bearer ${sentryToken}`,
                'Content-Type': 'application/json'
            }
        }).then(resp => {
            const dsn = resp.data.data.dsn.secret;
            next(null, dsn);
        }).catch(err => {
            next(err);
        });
    },
    function (dsn, next) {
        // 替换 dsn
        const content = appMainContent.replace('https://<key>@app.getsentry.com/<project>', dsn);

        try {
            fs.writeFileSync(APP_MAIN_PATH, content);
        } catch (e) {
            return next(e);
        }

        next();
    },
    function (next) {
        // commit 文件, push 文件
        const branch = gitUtil.getBranch();
        try {
            execSync(`git add ./src/App.js && git commit -m "feat: add sentry dsn url && git push origin HEAD:${branch}"`, { stdio: 'ignore' });
        } catch (e) {
            return next(e);
        }

        next();
    }
], function (err) {
    if (err) {
        console.log(err);
        process.exit(1);
    }

    console.log('Success: change sentry dsn success');
});
