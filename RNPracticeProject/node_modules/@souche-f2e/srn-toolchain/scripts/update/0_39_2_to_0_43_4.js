'use strict';

const execSync = require('child_process').execSync;
const fs = require('fs');
const path = require('path');

const chalk = require('chalk');
const ora = require('ora');
const semver = require('semver');

const packageJsonPath = path.resolve(process.cwd(), './package.json');
const packageJson = require(packageJsonPath);

if (packageJson['dependencies']['react-native'] !== '0.39.2') {
    console.log(chalk.yellow('Warnning: 只能在 0.39.2 版本基础上升级'));
    process.exit(1);
}

/**
 * 升级需要修改的依赖
 */
packageJson['dependencies']['mobx-react'] = '4.1.8';
packageJson['dependencies']['react'] = '16.0.0-alpha.6';
packageJson['dependencies']['react-native'] = '0.43.4';
packageJson['dependencies']['@souche-f2e/srn'] = '0.11.8';

packageJson['devDependencies']['@souche-f2e/react-native'] = '0.43.4';
packageJson['devDependencies']['react-test-renderer'] = '16.0.0-alpha.6';

/**
 * 将 module_info.json 添加到 .ignore
 */
execSync('echo "{}" > module_info.json');
execSync('echo "module_info.json" >> .gitignore');

/**
 * 升级一个大版本
 */
packageJson['version'] = semver.inc(packageJson.version, 'minor');

/**
 * 保存一些信息
 */
let username = execSync('git config --global user.name', { encoding: 'utf8' }) || '';
let email = execSync('git config --global user.email', { encoding: 'utf8' }) || '';
let gitReopUrl = execSync('git remote --verbose', { encoding: 'utf8' }) || '';
gitReopUrl = gitReopUrl.replace(/http:\/\/git.souche-inc.com\//g, 'git@git.souche-inc.com:');

email = email.replace(/[\n\t ]/g, '');
username = username.replace(/[\n\t ]/g, '');
gitReopUrl = gitReopUrl.match(/\t(git@.+) /)[1];

packageJson['description'] = '';
packageJson['repository'] = {
    type: 'git',
    url: gitReopUrl
};
packageJson['license'] = 'MIT';
packageJson['author'] = {
    name: username,
    email: email
};

/**
 * 修改 Makefile
 */
const makefilePath = path.resolve(process.cwd(), './Makefile');
let makefileContent = fs.readFileSync(makefilePath, 'utf8');
makefileContent = makefileContent.replace(
    'VERSION=$(shell node -p -e "require(\'./package.json\').version")',
    '# VERSION 通过 make publish-prod VERSION="0.1.1" 方式传递'
);
makefileContent = makefileContent.replace('root@', 'souche@');
makefileContent = makefileContent.replace('115.29.202.141', '10.165.13.29');

fs.writeFileSync(makefilePath, makefileContent, { encoding: 'utf8' });

/**
 * 保存并重新安装依赖
 */
fs.writeFileSync(packageJsonPath, JSON.stringify(packageJson, null, 2), { encoding: 'utf8' });

// 删除原来的依赖
execSync('rm -rf ./node_modules');

// 安装依赖
const spinner = ora('重新安装依赖...');
spinner.start();
execSync('npm run i');
spinner.succeed('安装依赖完成');

/**
 * 不兼容的升级提醒
 */
console.log(chalk.green(`
    请注意需改 package.json 中的 description, repository, license, author 字段内容
`));

console.log(chalk.green(`
    如果在 RN 代码中用到了 React.PropTypes 或者 React.createClass

    请按照 https://facebook.github.io/react/blog/2017/04/07/react-v15.5.0.html 文章进行升级
`));
